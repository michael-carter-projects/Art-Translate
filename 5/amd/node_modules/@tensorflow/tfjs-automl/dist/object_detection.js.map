{"version":3,"file":"object_detection.js","sourceRoot":"","sources":["../src/object_detection.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @license\n * Copyright 2019 Google LLC. All Rights Reserved.\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n * =============================================================================\n */\n\nimport {GraphModel, loadGraphModel} from '@tensorflow/tfjs-converter';\nimport {cast, dispose, expandDims, image, Tensor, Tensor2D, tidy} from '@tensorflow/tfjs-core';\n\nimport {ImageInput} from './types';\nimport {imageToTensor, loadDictionary} from './util';\n\nconst DEFAULT_TOPK = 20;\nconst DEFAULT_IOU_THRESHOLD = 0.5;\nconst DEFAULT_SCORE_THRESHOLD = 0.5;\n\nconst INPUT_NODE_NAME = 'ToFloat';\nconst OUTPUT_NODE_NAMES =\n    ['Postprocessor/convert_scores', 'Postprocessor/Decode/transpose_1'];\n\nexport interface ObjectDetectionOptions {\n  /**\n   * Only the `topk` most likely objects are returned. The actual number of\n   * objects might be less than this number.\n   */\n  topk?: number;\n  /**\n   * Intersection over union threshold. IoU is a metric between 0 and 1 used to\n   * measure the overlap of two boxes. The predicted boxes will not overlap more\n   * than the specified threshold.\n   */\n  iou?: number;\n  /** Boxes with score lower than this threshold will be ignored. */\n  score?: number;\n}\n\n/** Contains the coordinates of a bounding box. */\nexport interface Box {\n  /** Number of pixels from the top of the image (top padding). */\n  top: number;\n  /** Number of pixels from the left of the image (left padding). */\n  left: number;\n  /** The width of the box. */\n  width: number;\n  /** The height of the box. */\n  height: number;\n}\n\n/** The predicted object, which holds the score, label and bounding box. */\nexport interface PredictedObject {\n  box: Box;\n  score: number;\n  label: string;\n}\n\nexport class ObjectDetectionModel {\n  constructor(public graphModel: GraphModel, public dictionary: string[]) {}\n\n  async detect(input: ImageInput, options?: ObjectDetectionOptions):\n      Promise<PredictedObject[]> {\n    options = sanitizeOptions(options);\n    const img = tidy(() => this.preprocess(input, options));\n    const [height, width] = [img.shape[1], img.shape[2]];\n    const feedDict: {[name: string]: Tensor} = {};\n    feedDict[INPUT_NODE_NAME] = img;\n    const [scoresTensor, boxesTensor] =\n        await this.graphModel.executeAsync(feedDict, OUTPUT_NODE_NAMES) as\n        Tensor[];\n\n    const [, numBoxes, numClasses] = scoresTensor.shape;\n    const [scores, boxes] =\n        await Promise.all([scoresTensor.data(), boxesTensor.data()]);\n    const {boxScores, boxLabels} =\n        calculateMostLikelyLabels(scores as Float32Array, numBoxes, numClasses);\n\n    // Sort the boxes by score, ignoring overlapping boxes.\n    const selectedBoxesTensor = await image.nonMaxSuppressionAsync(\n        boxesTensor as Tensor2D, boxScores, options.topk, options.iou,\n        options.score);\n    const selectedBoxes = await selectedBoxesTensor.data() as Int32Array;\n    dispose([img, scoresTensor, boxesTensor, selectedBoxesTensor]);\n\n    const result = buildDetectedObjects(\n        width, height, boxes as Float32Array, boxScores, boxLabels,\n        selectedBoxes, this.dictionary);\n    return result;\n  }\n\n  private preprocess(input: ImageInput, options: ObjectDetectionOptions) {\n    return cast(expandDims(imageToTensor(input)), 'float32');\n  }\n}\n\nexport async function loadObjectDetection(modelUrl: string):\n    Promise<ObjectDetectionModel> {\n  const [model, dict] =\n      await Promise.all([loadGraphModel(modelUrl), loadDictionary(modelUrl)]);\n  return new ObjectDetectionModel(model, dict);\n}\n\nfunction sanitizeOptions(options: ObjectDetectionOptions) {\n  options = options || {} as ObjectDetectionOptions;\n  if (options.topk == null) {\n    options.topk = DEFAULT_TOPK;\n  }\n  if (options.iou == null) {\n    options.iou = DEFAULT_IOU_THRESHOLD;\n  }\n  if (options.score == null) {\n    options.score = DEFAULT_SCORE_THRESHOLD;\n  }\n  return options;\n}\n\nfunction calculateMostLikelyLabels(\n    scores: Float32Array, numBoxes: number,\n    numClasses: number): {boxScores: number[], boxLabels: number[]} {\n  // Holds a score for each box.\n  const boxScores: number[] = [];\n  // Holds the label id for each box.\n  const boxLabels: number[] = [];\n  for (let i = 0; i < numBoxes; i++) {\n    let maxScore = Number.MIN_VALUE;\n    let mostLikelyLabel = -1;\n    for (let j = 0; j < numClasses; j++) {\n      const flatIndex = i * numClasses + j;\n      const score = scores[flatIndex];\n      if (score > maxScore) {\n        maxScore = scores[flatIndex];\n        mostLikelyLabel = j;\n      }\n    }\n    boxScores[i] = maxScore;\n    boxLabels[i] = mostLikelyLabel;\n  }\n  return {boxScores, boxLabels};\n}\n\nfunction buildDetectedObjects(\n    width: number, height: number, boxes: Float32Array, boxScores: number[],\n    boxLabels: number[], selectedBoxes: Int32Array,\n    dictionary: string[]): PredictedObject[] {\n  const objects: PredictedObject[] = [];\n  // Each 2d rectangle is fully described with 4 coordinates.\n  const numBoxCoords = 4;\n  for (let i = 0; i < selectedBoxes.length; i++) {\n    const boxIndex = selectedBoxes[i];\n    const [top, left, bottom, right] = Array.from(boxes.slice(\n        boxIndex * numBoxCoords, boxIndex * numBoxCoords + numBoxCoords));\n    objects.push({\n      box: {\n        left: left * width,\n        top: top * height,\n        width: (right - left) * width,\n        height: (bottom - top) * height,\n      },\n      label: dictionary[boxLabels[boxIndex]],\n      score: boxScores[boxIndex],\n    });\n  }\n  return objects;\n}\n"]}